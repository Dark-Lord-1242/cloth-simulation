<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Cloth Simulation + Camera Hand Control</title>

  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #111;
    }
    canvas {
      display: block;
    }
  </style>
</head>

<body>

<video id="video" autoplay playsinline style="display:none"></video>
<canvas id="canvas"></canvas>

<script>
/* ================= BASIC SETUP ================= */

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resize();
window.addEventListener("resize", resize);

const mouse = {
  x: 0, y: 0,
  px: 0, py: 0,
  down: false,
  button: 0
};

let handActive = false;

/* ================= MOUSE CONTROL ================= */

canvas.addEventListener("mousemove", e => {
  if (handActive) return;
  mouse.x = e.clientX;
  mouse.y = e.clientY;
});

canvas.addEventListener("mousedown", e => {
  if (handActive) return;
  mouse.down = true;
});

canvas.addEventListener("mouseup", e => {
  if (handActive) return;
  mouse.down = false;
});

/* ================= CLOTH SIMULATION ================= */

const spacing = 10;
const cols = 40;
const rows = 30;
const gravity = 0.5;
const friction = 0.999;

class Point {
  constructor(x, y, pinned = false) {
    this.x = x;
    this.y = y;
    this.oldx = x;
    this.oldy = y;
    this.pinned = pinned;
  }

  update() {
    if (this.pinned) return;

    let vx = (this.x - this.oldx) * friction;
    let vy = (this.y - this.oldy) * friction;

    this.oldx = this.x;
    this.oldy = this.y;

    this.x += vx;
    this.y += vy + gravity;

    if (mouse.down) {
      const dx = this.x - mouse.x;
      const dy = this.y - mouse.y;
      const dist = Math.sqrt(dx*dx + dy*dy);

      if (dist < 20) {
        this.x = mouse.x;
        this.y = mouse.y;
      }
    }
  }

  draw() {
    ctx.fillRect(this.x, this.y, 1, 1);
  }
}

class Stick {
  constructor(p0, p1) {
    this.p0 = p0;
    this.p1 = p1;
    this.length = spacing;
  }

  update() {
    const dx = this.p1.x - this.p0.x;
    const dy = this.p1.y - this.p0.y;
    const dist = Math.sqrt(dx*dx + dy*dy);
    const diff = (this.length - dist) / dist * 0.5;

    if (!this.p0.pinned) {
      this.p0.x -= dx * diff;
      this.p0.y -= dy * diff;
    }
    if (!this.p1.pinned) {
      this.p1.x += dx * diff;
      this.p1.y += dy * diff;
    }
  }

  draw() {
    ctx.beginPath();
    ctx.moveTo(this.p0.x, this.p0.y);
    ctx.lineTo(this.p1.x, this.p1.y);
    ctx.stroke();
  }
}

const points = [];
const sticks = [];

for (let y = 0; y < rows; y++) {
  for (let x = 0; x < cols; x++) {
    const p = new Point(
      100 + x * spacing,
      20 + y * spacing,
      y === 0
    );
    points.push(p);

    if (x > 0)
      sticks.push(new Stick(p, points[points.length - 2]));
    if (y > 0)
      sticks.push(new Stick(p, points[(y - 1) * cols + x]));
  }
}

/* ================= CAMERA HAND CONTROL ================= */

const video = document.getElementById("video");

const hands = new Hands({
  locateFile: file =>
    `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});

hands.setOptions({
  maxNumHands: 1,
  minDetectionConfidence: 0.7,
  minTrackingConfidence: 0.7
});

hands.onResults(results => {
  if (!results.multiHandLandmarks) {
    handActive = false;
    return;
  }

  const hand = results.multiHandLandmarks[0];
  const palm = hand[9];

  mouse.x = (1 - palm.x) * canvas.width;
  mouse.y = palm.y * canvas.height;

  const thumb = hand[4];
  const index = hand[8];
  const pinch = Math.hypot(thumb.x - index.x, thumb.y - index.y);

  mouse.down = pinch < 0.05;
  handActive = true;
});

const camera = new Camera(video, {
  onFrame: async () => {
    await hands.send({ image: video });
  },
  width: 640,
  height: 480
});

camera.start();

/* ================= MAIN LOOP ================= */

function update() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.strokeStyle = "#aaa";
  ctx.fillStyle = "#fff";

  points.forEach(p => p.update());
  for (let i = 0; i < 3; i++)
    sticks.forEach(s => s.update());

  sticks.forEach(s => s.draw());
  points.forEach(p => p.draw());

  if (!handActive) {
    mouse.px = mouse.x;
    mouse.py = mouse.y;
  }

  requestAnimationFrame(update);
}

update();
</script>

</body>
</html>
